<html>
  <head>
    <!--Jquery & Bootstrap imports-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <!--Select2-->
    <link
      href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <!--Leaflet Imports-->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
      integrity="sha384-BF7C732iE6WuqJMhUnTNJJLVvW1TIP87P2nMDY7aN2j2EJFWIaqK89j3WlirhFZU"
      crossorigin="anonymous"
    />

    <style>
      h1 {
        text-align: center;
        padding-top: 2vh;
      }
      #map {
        height: 75%;
        width: 100%;
      }
      .dropdownsFilters {
        display: flex;
        text-align: center;
        justify-content: space-around;
        flex-wrap: wrap;
      }
      .dropdown {
        text-align: center;
      }
      select {
        width: 30vw;
      }
    </style>

    <!-- Make sure you put this AFTER Leaflet's CSS -->
    <script
      src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js"
      integrity="sha384-/I247jMyT/djAL4ijcbNXfX+PA8OZmkwzUr6Gotpgjz1Rxti1ZECG9Ne0Dj1pXrx"
      crossorigin="anonymous"
    ></script>

    <!--Market Cluster Groups-->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"
      integrity="sha384-5kMSQJ6S4Qj5i09mtMNrWpSi8iXw230pKU76xTmrpezGnNJQzj0NzXjQLLg+jE7k"
      crossorigin="anonymous"
    />
    <script
      src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"
      integrity="sha384-RLIyj5q1b5XJTn0tqUhucRZe40nFTocRP91R/NkRJHwAe4XxnTV77FXy/vGLiec2"
      crossorigin="anonymous"
    ></script>

    <title>Central Park Squirrel Finder</title>
  </head>
  <body>
    <h1>Central Park Squirrel Finder</h1>
    <form method="GET" action="/filter">
      <div class="dropdownsFilters">
        <div class="dropdown">
          <select name="firstNames[]" id="firstNames" multiple="multiple">
            {% for name in names %}
            <option value="{{name}}">{{name}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="dropdown">
          <select name="parkZones[]" id="parkZones" multiple="multiple">
            {% for zone in zone_names %}
            <option value="{{zone}}">{{zone}}</option>
            {% endfor %}
          </select>
        </div>
        <div class="dropdown">
          <select name="entranceZones[]" id="entranceZones" multiple="multiple">
            {% for entrance in entrance_names %}
            <option value="{{entrance}}">{{entrance}}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <br />
      <input type="submit" value="Filter" />
    </form>
    <div id="map"></div>
    <meta
      id="my-data"
      data-name="{{spottings | safe}}"
      data-other="{{other}}"
    />
  </body>

  <script>
    var mymap = L.map("map").setView([40.7831, -73.9671], 14);

    L.tileLayer(
      "https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token={accessToken}",
      {
        attribution:
          'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        id: "mapbox/streets-v11",
        tileSize: 512,
        zoomOffset: -1,
        accessToken:
          "pk.eyJ1Ijoid29sZmZydW9mZiIsImEiOiJja3ZmaXUyeWRicmx2MnBtYTc5c25odmpjIn0.kAtewKXi33jO9VbeYuBPkA",
      }
    ).addTo(mymap);

    // Popup coords where clicking
    var popup = L.popup();
    function onMapClick(e) {
      popup
        .setLatLng(e.latlng)
        .setContent("You clicked the map at " + e.latlng.toString())
        .openOn(mymap);
    }
    mymap.on("click", onMapClick);

    //Jquery populate map with spottings
    function populate() {
      var spottings = {{spottings|safe}};

      var markers = L.markerClusterGroup();
      spottings.forEach(function(spotting) {
        var location = spotting["location"].split(/[(,),]/);
        markers.addLayer(L.marker([location[1], location[2]])
          .bindPopup(
            `Name: ${spotting["firstname"]} <br/>
            Zone: ${spotting["zone"]} <br/>
            Color: ${spotting["color"]} <br/>
            Age: ${spotting["age"]} <br/>
            Sound Made: ${spotting["sound"]}`
          ));
      mymap.addLayer(markers);
      });
      /*
      spottings.forEach(function(spotting) {
        var location = spotting["location"].split(/[(,),]/);
        L.marker([location[1], location[2]])
          .addTo(mymap)
          .bindPopup(
            `Name: ${spotting["firstname"]} <br/>
            Zone: ${spotting["zone"]} <br/>
            Color: ${spotting["color"]} <br/>
            Age: ${spotting["age"]} <br/>
            Sound Made: ${spotting["sound"]}`
          );
      });*/
    };
    //Jquery for dropdowns
    $(document).ready(function () {
      $("#firstNames").select2({
        placeholder: "Filter By Name",
        closeOnSelect: false,
        width: "resolve",
      });
      $("#parkZones").select2({
        placeholder: "Filter by Park Zones",
        closeOnSelect: false,
        width: "resolve",
      });
      $("#entranceZones").select2({
        placeholder: "Filter By Nearest Subway Entrances",
        closeOnSelect: false,
        width: "resolve",
      });
      populate();
    });
  </script>
</html>
